\documentclass{article}
\input{../../../lib.sty}
\input{../../../measures/mod.sty}


\title{\texttt{fn make\_bounded\_range\_to\_zCDP}}
\author{Tudor Cebere}

\begin{document}
\maketitle

\contrib
Proves soundness of \texttt{bounded\_range\_to\_zCDP} in \asOfCommit{mod.rs}{0b8f4222}.
The conversion between bounded range \cite{durfee2019practical} and zCDP comes from Lemma~3.2 in \cite{cesar2020unifying}.
The proof in this document is an adaptation of Theorem 5 \href{https://differentialprivacy.org/exponential-mechanism-bounded-range/}{here}.

\section{Hoare Triple}
\subsection*{Preconditions}
\subsubsection*{Compiler-verified}
\begin{itemize}
    \item Variable \texttt{meas} is a valid measurement of type \texttt{Measurement<DI, TO, MI, RangeDivergence>}
    \item Generic \texttt{DI} (input domain) is a type with trait \rustdoc{core/trait}{Domain}. 
    \item Generic \texttt{MI} (input metric) is a type with trait \rustdoc{core/trait}{Metric}.
    \item \rustdoc{core/trait}{MetricSpace} is implemented for \texttt{(DI, MI)}. Therefore \texttt{MI} is a valid metric on \texttt{DI}.
\end{itemize}

\subsubsection*{Human-verified}
None

\subsection*{Pseudocode}

\lstinputlisting[language=Python,firstline=2,escapechar=|]{./pseudocode/make_bounded_range_to_zCDP.py}

\subsection*{Postcondition}

\begin{theorem}[Postcondition]
    \label{postcondition}
    \validMeasurement{\texttt{(meas, DI, TO, MI)\\}}{\texttt{make\_bounded\_range\_to\_zCDP}}
\end{theorem}

By the precondition, \texttt{meas} is a valid measurement with \texttt{RangeDivergence} privacy measure.

\defRangeDivergence

\defPrivacyLoss

\begin{lemma} 
    \label{lemma:PRV_lemma_1}
    Given a privacy loss random variable $Z$ with respect to random variables $Y$ and $Y'$,
    if $\mathrm{supp}(Y) = \mathrm{supp}(Y')$, then
    \begin{equation}
      \mathop{\mathbb{E}}_{y \sim Y}\left[\exp(-Z)\right] = 1.
    \end{equation}
\end{lemma}

\begin{proof}
    \begin{align}
        &\mathop{\mathbb{E}}_{y \sim Y}\left[\exp(-Z)\right] \\
        &= \int_{\mathrm{supp}(Y)} \exp(-Z) dY \\
        &= \int_{\mathrm{supp}(Y)} \mathbb{P}\left[Y = y\right] \cdot \exp(-\mathcal{L}_{Y, Y'}(y)) dy && \text{by Definition~} \ref{defPrivacyLoss} \\
        &= \int_{\mathrm{supp}(Y)} \mathbb{P}\left[Y = y\right] \cdot \frac{\mathbb{P}[Y' = y]}{\mathbb{P}[Y = y]} dy \\
        &= \int_{\mathrm{supp}(Y')} \mathbb{P}[Y' = y] dy && \text{since } Y \text{ and } Y' \text{ have the same support} \\
        &= 1
    \end{align}
\end{proof}

\begin{definition}[Hoeffding's Lemma]
    \label{defHoeffding}
    Let $X$ be a random variable supported on $[a, b]$. Then for any $\lambda \in \mathbb{R}$,
    \begin{equation}
        \mathbb{E}\left[\exp(\lambda X)\right] \leq \exp(\mathbb{E}[X] \cdot \lambda + \frac{(b - a)^2}{8} \cdot \lambda^2)
    \end{equation}
\end{definition}

\begin{lemma} 
    Given two distributions $Y$ and $Y'$ that are $\eta$-close under range divergence,
    then the associated privacy loss random variable satisfies
    \label{lemma:PRV_lemma_2}
    \begin{equation}
        \mathbb{E}\left[Z\right] \leq \frac{1}{8}\eta^2
    \end{equation}
\end{lemma}

\begin{proof}
\begin{align}
    \mathbb{E}\left[\exp(-Z)\right] & \leq \exp(-\mathbb{E}[Z] + \frac{\eta^2}{8}) && \text{by \ref{defHoeffding} since } Z \in [-t, \eta - t] \text{, let } \lambda = -1 \\
    \implies \mathbb{E}\left[Z\right] & \leq \frac{\eta^2}{8} - \log{\mathbb{E}[\exp(-Z)]} && \text{rearrange terms} \\
    & = \frac{\eta^2}{8} && \text{by Lemma~\ref{lemma:PRV_lemma_1}}
\end{align}

Lemma~\ref{lemma:PRV_lemma_1} can only be applied when $Y$ and $Y'$ have the same support.
This requirement is satisfied via a proof by contradiction: if $Y$ and $Y'$ have different supports, 
then the privacy loss would be infinite,
meaning that $Y$ and $Y'$ are not $\eta$-close under range divergence.
\end{proof}

\defZcdpPlrv

\begin{theorem}[Range Divergence implies zero-Concentrated Divergence]
    \label{thm:br_to_zcdp}
    If two random variables $Y$ and $Y'$ are $\eta$-close under range divergence,
    then they are also $\frac{1}{8}\eta^2$-close under zero-concentrated divergence.
\end{theorem}

\begin{proof}
\begin{align}
    & \mathbb{E}\left[\exp(\alpha Z)\right] && \text{starting from Definition~\ref{defZcdpPlrv}}\\
    & \leq \exp(\mathbb{E}[Z] \alpha + \frac{\eta^2}{8} \alpha^2) && \text{by \ref{defHoeffding} since } Z \in [-t, \eta - t] \text{, let } \lambda = \alpha \\
    & \leq \exp(\frac{\eta^2}{8} \alpha + \frac{\eta^2}{8} \alpha^2) && \text{by Lemma~\ref{lemma:PRV_lemma_2}} \\
    & = \exp(\frac{\eta^2}{8} \alpha \left( \alpha + 1\right)) \\
    & = \exp(\alpha \left( \alpha + 1\right) \rho) && \text{where } \rho = \frac{\eta^2}{8}
\end{align}
\end{proof}


\begin{proof}[Proof of Theorem~\ref{postcondition}]
    By the postcondition of \texttt{Measurement.with\_map}, on line~\ref{with_map}, \\
    \texttt{make\_bounded\_range\_to\_zCDP} returns a measurement with the same input metric, 
    output metric \\\rustdoc{measures/struct}{ZeroConcentratedDivergence}, 
    and a privacy map that computes $\eta^2 / 8$ with conservative rounding.
    The privacy guarantee holds by the precondition that \texttt{meas} is valid measurement,
    together with Theorem~\ref{thm:br_to_zcdp}.
    Therefore the returned measurement is a valid measurement.
\end{proof}

\bibliographystyle{alpha}
\bibliography{mod}

\end{document}

name: Latex Build

on:
  pull_request:

jobs:
  pre-latex-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Collect diffs
        id: "diffs"
        run: |
          tex=$(git --no-pager diff --name-only origin/${{ github.event.pull_request.base.ref }} -- '*.tex')

          tex="${tex//'%'/'%25'}"
          tex="${tex//$'\n'/'%0A'}"
          tex="${tex//$'\r'/'%0D'}"
          echo "::set-output name=tex::$tex"
    outputs:
     tex: ${{ steps.diffs.outputs.tex }}

      
  latex-build:
    needs: [pre-latex-build, "${{ needs.pre-latex-build.outputs.tex }}"]
    if: needs.pre-latex-build.outputs.tex != ""
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Compile LaTeX documents
        uses: xu-cheng/latex-action@v2
        with:
          root_file: ${{ steps.diffs.outputs.tex }}
          work_in_root_file_dir: true

      - name: Pull request artifacts
        uses: Shoeboxam/pull-request-artifacts@main
        with:
          commit: ${{ github.event.pull_request.head.sha }}
          glob-pattern: rust/**/*.pdf
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          artifacts-token: ${{ secrets.ARTIFACTS_REPO_TOKEN }}
          artifacts-repo: opendp/artifacts
